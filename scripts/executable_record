#!/bin/bash
# Modern screen recording with gpu-screen-recorder (hardware encoding)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/screen-recorder/modules/base.sh"

if is_recording; then
  # Stop recording
  FILENAME=$(get_output_file)
  PID=$(get_recording_pid)
  
  kill -SIGINT "$PID" 2>/dev/null
  
  # Wait a moment for file to finalize
  sleep 0.5
  
  clear_state
  refresh_waybar
  
  if [ -f "$FILENAME" ]; then
    {
      echo "file://$FILENAME"
      echo "$FILENAME"
    } | wl-copy --type text/uri-list
    notify-send "Screen Recording" "Recording stopped and saved to:\n$FILENAME\n(File copied to clipboard)"
  else
    notify-send "Screen Recording" "Recording stopped"
  fi
else
  # Start recording with region selection
  REGION=$(slurp -f "%wx%h+%x+%y")
  if [ -n "$REGION" ]; then
    FILENAME=~/Videos/$(date +%s).mp4
    
    gpu-screen-recorder -w region -region "$REGION" -f 60 -c mp4 -k auto -o "$FILENAME" &
    PID=$!
    
    echo "$PID" > "$PIDFILE"
    set_output_file "$FILENAME"
    refresh_waybar
    
    notify-send "Screen Recording" "Recording started..."
  fi
fi