#cloud-config
# Cloud-init configuration template for E2E test VMs

# User configuration
users:
  - name: {{ test_user }}
    gecos: "E2E Test User"
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    plain_text_passwd: {{ test_user_password }}
    ssh_authorized_keys:
{% if ssh_public_key %}
      - {{ ssh_public_key }}
{% endif %}

# System packages to install
packages:
  - openssh-server
  - git
  - curl
  - wget
  - sudo
  - vim
{% if distribution == "arch" %}
  - base-devel
{% elif distribution == "fedora" %}
  - dnf-plugins-core
{% endif %}

# Commands to run after boot
runcmd:
  - systemctl enable ssh
  - systemctl start ssh
  - systemctl enable sshd
  - systemctl start sshd
  # Ensure test user has proper permissions
  - usermod -aG wheel {{ test_user }}
{% if distribution == "arch" %}
  - usermod -aG sudo {{ test_user }}
{% endif %}
  # Configure SSH for password authentication (for testing)
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart sshd
  # Set up directory structure
  - mkdir -p /home/{{ test_user }}/.config
  - chown -R {{ test_user }}:{{ test_user }} /home/{{ test_user }}
  # Log system information for debugging
  - echo "=== System Info ===" > /var/log/cloud-init-debug.log
  - uname -a >> /var/log/cloud-init-debug.log
  - cat /etc/os-release >> /var/log/cloud-init-debug.log
  - ip addr show >> /var/log/cloud-init-debug.log
  - systemctl status sshd >> /var/log/cloud-init-debug.log

# SSH configuration
ssh_pwauth: true
disable_root: false

# Configure timezone
timezone: UTC

# Final message
final_message: "E2E test VM is ready for testing!"