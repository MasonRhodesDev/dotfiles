#!/bin/bash
# Setup Jujutsu VCS for chezmoi dotfiles

set -e

echo "Setting up Jujutsu (jj) for chezmoi..."

# Check if jj is installed
if ! command -v jj &> /dev/null; then
    echo "Installing jujutsu..."
{{- if eq .chezmoi.osRelease.id "arch" }}
    sudo pacman -S --noconfirm jujutsu
{{- else if eq .chezmoi.osRelease.id "fedora" }}
    # No official Fedora package - use cargo install
    # See: https://github.com/jj-vcs/jj/issues/6469
    if command -v cargo &> /dev/null; then
        cargo install --locked jj-cli
    else
        echo "Error: cargo not found. Install rust/cargo first, then run: cargo install --locked jj-cli"
        exit 1
    fi
{{- else }}
    echo "Warning: jujutsu not available for this OS"
    echo "Install manually: https://github.com/jj-vcs/jj"
    exit 0
{{- end }}
fi

# Initialize jj in chezmoi repo if not already done
CHEZMOI_DIR="$HOME/.local/share/chezmoi"
if [ ! -d "$CHEZMOI_DIR/.jj" ]; then
    echo "Initializing jj in colocated mode..."
    cd "$CHEZMOI_DIR"
    jj git init --colocate

    # Set trunk() alias for repo
    echo "Configuring jj trunk() alias..."
    jj config set --repo 'revset-aliases."trunk()"' 'personal-pc@origin'

    # Track remote bookmarks
    jj bookmark track main@origin personal-pc@origin work-pc@origin || true

    echo "✅ Jujutsu initialized successfully"
else
    echo "✅ Jujutsu already initialized"
fi

# Suppress git detached HEAD warnings
git -C "$CHEZMOI_DIR" config advice.detachedHead false

echo "✅ Jujutsu setup complete"
