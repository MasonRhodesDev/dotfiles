# Fedora Kickstart Configuration for E2E Testing Base Image
# Use text mode install
text

# Language and keyboard
lang en_US.UTF-8
keyboard --vckeymap=us --xlayouts='us'

# Network configuration
network --bootproto=dhcp --device=eth0 --onboot=on --activate

# Repository configuration
url --url="https://download.fedoraproject.org/pub/fedora/linux/releases/39/Everything/x86_64/os/"

# Root password (will be disabled later)
rootpw --lock

# Create test user
user --groups=wheel --name=testuser --password=testpass123 --plaintext --gecos="Test User"

# Timezone
timezone UTC --isUtc

# Bootloader configuration
bootloader --location=mbr --boot-drive=vda

# Clear partitions and create new ones
clearpart --all --initlabel --drives=vda

# Disk partitioning
part /boot --fstype=xfs --size=1024 --ondisk=vda
part pv.01 --size=1 --grow --ondisk=vda
volgroup vg_main pv.01
logvol / --fstype=xfs --name=lv_root --vgname=vg_main --size=30720 --grow
logvol swap --fstype=swap --name=lv_swap --vgname=vg_main --size=4096

# Package selection - minimal install
%packages --ignoremissing
@core
openssh-server
cloud-init
sudo
git
curl
wget
-NetworkManager-*
%end

# Services to enable
services --enabled=sshd,cloud-init,cloud-init-local,cloud-config,cloud-final

# Post-installation script
%post --log=/root/ks-post.log
# Configure sudo for wheel group without password
echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Configure SSH
systemctl enable sshd

# Configure cloud-init datasource
echo 'datasource_list: [NoCloud]' > /etc/cloud/cloud.cfg.d/99_datasource.cfg

# Clean up
dnf clean all
%end

# Reboot after installation
reboot