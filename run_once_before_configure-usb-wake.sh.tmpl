#!/bin/bash
# Configure USB wake from suspend for keyboard/mouse through KVM switch

set -e

echo "Configuring USB wake settings..."

# Enable wake for keyboard (ZSA Voyager)
KEYBOARD_PATH=$(grep -r "Voyager" /sys/bus/usb/devices/*/product 2>/dev/null | head -1 | cut -d: -f1 | sed 's/product$/power\/wakeup/')
if [ -n "$KEYBOARD_PATH" ] && [ -f "$KEYBOARD_PATH" ]; then
    echo "Enabling wake for keyboard..."
    echo enabled | sudo tee "$KEYBOARD_PATH" > /dev/null
fi

# Enable wake for mouse (Logitech Lightspeed)
MOUSE_PATH=$(grep -r "Lightspeed" /sys/bus/usb/devices/*/product 2>/dev/null | head -1 | cut -d: -f1 | sed 's/product$/power\/wakeup/')
if [ -n "$MOUSE_PATH" ] && [ -f "$MOUSE_PATH" ]; then
    echo "Enabling wake for mouse..."
    echo enabled | sudo tee "$MOUSE_PATH" > /dev/null
fi

# Enable wake for USB hubs (Genesys Logic hubs that devices connect through)
for hub in /sys/bus/usb/devices/*/product; do
    if grep -q "Hub" "$hub" 2>/dev/null; then
        HUB_WAKE="${hub%/product}/power/wakeup"
        if [ -f "$HUB_WAKE" ]; then
            echo "Enabling wake for hub: $(cat $hub)"
            echo enabled | sudo tee "$HUB_WAKE" > /dev/null
        fi
    fi
done

echo "USB wake configuration complete"
