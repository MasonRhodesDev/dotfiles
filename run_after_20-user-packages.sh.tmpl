#!/bin/bash
# User-level package installation (no sudo required)
# Runs AFTER system packages are installed

set +e
set -u
set -o pipefail

SCRIPT_DIR="{{ .chezmoi.sourceDir }}/.chezmoitemplates/lib"
source "$SCRIPT_DIR/lib-logging.sh"
source "$SCRIPT_DIR/lib-state.sh"
source "$SCRIPT_DIR/lib-collision.sh"
source "$SCRIPT_DIR/lib-helpers.sh"

PHASE="user"

# Initialize logging
init_log_file "$PHASE"

log_phase_start "User-Level Package Installation"

# Initialize state
init_state_db
init_collision_detection

# Acquire lock
if ! acquire_lock; then
    log_error "Could not acquire installation lock"
    exit 0
fi

# Build category list (user-level only)
CATEGORIES=()
{{- range $section, $packages := .packages }}
  {{- range $category, $config := $packages }}
    {{- $install_level := index $config "install_level" | default "system" }}
    {{- if eq $install_level "user" }}
      {{- if or (eq $section "common") (eq $section $.profile.type) }}
CATEGORIES+=("{{ $section }}.{{ $category }}")
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

if [ ${#CATEGORIES[@]} -eq 0 ]; then
    log_info "No user packages to install for this profile"
    exit 0
fi

log_info "User-level categories to install: ${#CATEGORIES[@]}"

# Install each category
FAILED=()
SUCCEEDED=()
SKIPPED=()

for category in "${CATEGORIES[@]}"; do
    if install_packages_from_registry "$category" "$PHASE"; then
        SUCCEEDED+=("$category")
    else
        local status=$(get_category_status "$PHASE" "$category")
        if [ "$status" = "skipped" ]; then
            SKIPPED+=("$category")
        else
            FAILED+=("$category")
        fi
    fi
done

# Post-install setup for specific tools
if command -v fnm &>/dev/null; then
    log_info "Setting up Node.js via fnm..."
    eval "$(fnm env --use-on-cd)" || true
    if ! fnm list | grep -q "lts"; then
        log_info "Installing Node.js LTS..."
        fnm install --lts || log_warn "Failed to install Node.js LTS"
        fnm use lts-latest || true
        fnm default lts-latest || true
    else
        log_info "Node.js LTS already installed"
    fi
fi

if command -v bun &>/dev/null; then
    log_info "Verifying bun installation..."
    bun --version || log_warn "bun installed but not working correctly"
fi

if command -v oh-my-posh &>/dev/null; then
    log_info "Verifying oh-my-posh installation..."
    oh-my-posh --version || log_warn "oh-my-posh installed but not working correctly"
fi

# Summary
echo ""
log_info "━━━ User Phase Summary ━━━"
log_info "Succeeded: ${#SUCCEEDED[@]}"
log_info "Skipped: ${#SKIPPED[@]}"
log_info "Failed: ${#FAILED[@]}"

if [ ${#SUCCEEDED[@]} -gt 0 ]; then
    log_info "✓ Successfully installed:"
    printf '  ✓ %s\n' "${SUCCEEDED[@]}"
fi

if [ ${#SKIPPED[@]} -gt 0 ]; then
    log_info "⊘ Skipped:"
    printf '  ⊘ %s\n' "${SKIPPED[@]}"
fi

if [ ${#FAILED[@]} -gt 0 ]; then
    log_error "✗ Failed categories:"
    printf '  ✗ %s\n' "${FAILED[@]}"
    echo ""
    log_warn "Review log for details: $(get_log_file)"
fi

log_phase_end "User Phase"
exit 0
