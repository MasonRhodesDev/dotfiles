#!/bin/bash
# Systemd sleep hook to maintain USB wake configuration across suspend/resume cycles
# Called by usb-wake-sleep-handler.service on PrepareForSleep signal

LOG_FILE="$HOME/.local/state/usb-wake-sleep.log"
mkdir -p "$(dirname "$LOG_FILE")"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

enable_usb_wake() {
    local action="$1"
    log_message "=== $action: Enabling USB wake configuration ==="

    # Enable USB controller
    if [ -f /sys/bus/pci/devices/0000:0e:00.3/power/wakeup ]; then
        echo enabled | sudo tee /sys/bus/pci/devices/0000:0e:00.3/power/wakeup > /dev/null 2>&1
        log_message "✓ USB controller wake enabled"
    fi

    # Enable all root hubs
    local root_hub_count=0
    for root_hub in /sys/bus/usb/devices/usb*/power/wakeup; do
        if [ -f "$root_hub" ]; then
            echo enabled | sudo tee "$root_hub" > /dev/null 2>&1
            root_hub_count=$((root_hub_count + 1))
        fi
    done
    log_message "✓ Enabled $root_hub_count root hubs"

    # Enable all intermediate hubs
    local hub_count=0
    for hub in /sys/bus/usb/devices/*/product; do
        if grep -q "Hub" "$hub" 2>/dev/null; then
            local hub_wake="${hub%/product}/power/wakeup"
            if [ -f "$hub_wake" ]; then
                echo enabled | sudo tee "$hub_wake" > /dev/null 2>&1
                hub_count=$((hub_count + 1))
            fi
        fi
    done
    log_message "✓ Enabled $hub_count intermediate hubs"

    # Enable keyboard (ZSA Voyager: 3297:1977)
    for device in /sys/bus/usb/devices/*/idVendor; do
        if [ "$(cat "$device" 2>/dev/null)" = "3297" ]; then
            local device_dir=$(dirname "$device")
            if [ "$(cat "$device_dir/idProduct" 2>/dev/null)" = "1977" ]; then
                local wakeup_path="$device_dir/power/wakeup"
                if [ -f "$wakeup_path" ]; then
                    echo enabled | sudo tee "$wakeup_path" > /dev/null 2>&1
                    log_message "✓ Keyboard wake enabled"
                fi
            fi
        fi
    done

    # Enable mouse (Logitech Lightspeed: 046d:c539)
    for device in /sys/bus/usb/devices/*/idVendor; do
        if [ "$(cat "$device" 2>/dev/null)" = "046d" ]; then
            local device_dir=$(dirname "$device")
            if [ "$(cat "$device_dir/idProduct" 2>/dev/null)" = "c539" ]; then
                local wakeup_path="$device_dir/power/wakeup"
                if [ -f "$wakeup_path" ]; then
                    echo enabled | sudo tee "$wakeup_path" > /dev/null 2>&1
                    log_message "✓ Mouse wake enabled"
                fi
            fi
        fi
    done

    log_message "=== $action complete ==="
}

# Main execution
case "$1" in
    pre)
        # Before suspend - ensure wake is enabled
        enable_usb_wake "PRE-SUSPEND"
        ;;
    post)
        # After resume - re-enable wake (kernel may have reset state)
        enable_usb_wake "POST-RESUME"
        ;;
    *)
        log_message "ERROR: Unknown action '$1'"
        exit 1
        ;;
esac

exit 0
