# Arch Linux test container for chezmoi dotfiles
FROM archlinux:latest

# Update system and install base dependencies
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
    git \
    curl \
    wget \
    sudo \
    base-devel \
    yq \
    which \
    procps-ng \
    && pacman -Scc --noconfirm

# Create test user (mason)
RUN useradd -m -s /bin/bash mason && \
    echo "mason ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set hostname for personal profile
RUN echo "mason-personal-test" > /etc/hostname

# Switch to test user
USER mason
WORKDIR /home/mason

# Install chezmoi
RUN sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /home/mason/.local/bin

# Add chezmoi to PATH
ENV PATH="/home/mason/.local/bin:${PATH}"

# Set up git config (required by chezmoi)
RUN git config --global user.email "test@example.com" && \
    git config --global user.name "Test User" && \
    git config --global init.defaultBranch main

# Install yay (AUR helper) - needed for AUR packages
RUN cd /tmp && \
    git clone https://aur.archlinux.org/yay.git && \
    cd yay && \
    makepkg -si --noconfirm && \
    cd ~ && \
    rm -rf /tmp/yay

# Copy dotfiles repo into container
COPY --chown=mason:mason . /home/mason/.local/share/chezmoi/

# Set chezmoi source directory
ENV CHEZMOI_SOURCE_DIR=/home/mason/.local/share/chezmoi

WORKDIR /home/mason

# Default command runs a shell
CMD ["/bin/bash"]
