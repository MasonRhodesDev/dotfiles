#!/bin/bash
# System-level package installation (requires sudo)
# Runs AFTER dotfiles are applied successfully

set +e          # Don't exit on error - continue to next phase
set -u          # Error on undefined variables
set -o pipefail # Pipe failures propagate

SCRIPT_DIR="{{ .chezmoi.sourceDir }}/.chezmoitemplates/lib"
source "$SCRIPT_DIR/lib-logging.sh"
source "$SCRIPT_DIR/lib-state.sh"
source "$SCRIPT_DIR/lib-collision.sh"
source "$SCRIPT_DIR/lib-helpers.sh"

PHASE="system"

# Initialize logging
init_log_file "$PHASE"
cleanup_old_logs 30

log_phase_start "System-Level Package Installation"

# Initialize state and collision detection
init_state_db
init_collision_detection

# Acquire lock
if ! acquire_lock; then
    log_error "Could not acquire installation lock"
    exit 0  # Exit gracefully so chezmoi continues
fi

# Check for migration needed
if needs_migration; then
    log_info "First run detected, checking for old software_installers..."
    if [ -d "$HOME/software_installers" ]; then
        log_warn "Old ~/software_installers found"
        log_warn "New system will manage packages via chezmoi"
        log_warn "Backing up old directory..."
        mv "$HOME/software_installers" "$HOME/software_installers.backup-$(date +%Y%m%d-%H%M%S)"
    fi
    mark_migration_complete
fi

# Validate prerequisites
if ! validate_prerequisites "$PHASE"; then
    log_error "Prerequisites not met for $PHASE phase"
    exit 0
fi

# Build category list for this phase (system-level only)
PACKAGE_REGISTRY="{{ .chezmoi.sourceDir }}/software_installers/packages.toml"
PROFILE_TYPE="{{ .profile.type }}"

CATEGORIES=()

for section in common work personal; do
    # Skip sections that don't match profile
    if [ "$section" = "work" ] && [ "$PROFILE_TYPE" != "work" ]; then
        continue
    fi
    if [ "$section" = "personal" ] && [ "$PROFILE_TYPE" != "personal" ]; then
        continue
    fi

    # Get all categories in this section
    cats=$(yq eval ".${section} | keys | .[]" "$PACKAGE_REGISTRY" 2>/dev/null)
    for category in $cats; do
        install_level=$(yq eval ".${section}.${category}.install_level // \"system\"" "$PACKAGE_REGISTRY" 2>/dev/null)
        if [ "$install_level" = "system" ]; then
            CATEGORIES+=("${section}.${category}")
        fi
    done
done

if [ ${#CATEGORIES[@]} -eq 0 ]; then
    log_info "No system packages to install for this profile"
    exit 0
fi

log_info "System-level categories to install: ${#CATEGORIES[@]}"

# Install each category
FAILED=()
SUCCEEDED=()
SKIPPED=()

for category in "${CATEGORIES[@]}"; do
    if install_packages_from_registry "$category" "$PHASE"; then
        SUCCEEDED+=("$category")
    else
        # Check if it was skipped vs failed
        local status=$(get_category_status "$PHASE" "$category")
        if [ "$status" = "skipped" ]; then
            SKIPPED+=("$category")
        else
            FAILED+=("$category")
        fi
    fi
done

# Summary
echo ""
log_info "━━━ System Phase Summary ━━━"
log_info "Succeeded: ${#SUCCEEDED[@]}"
log_info "Skipped: ${#SKIPPED[@]}"
log_info "Failed: ${#FAILED[@]}"

if [ ${#SUCCEEDED[@]} -gt 0 ]; then
    log_info "✓ Successfully installed:"
    printf '  ✓ %s\n' "${SUCCEEDED[@]}"
fi

if [ ${#SKIPPED[@]} -gt 0 ]; then
    log_info "⊘ Skipped:"
    printf '  ⊘ %s\n' "${SKIPPED[@]}"
fi

if [ ${#FAILED[@]} -gt 0 ]; then
    log_error "✗ Failed categories:"
    printf '  ✗ %s\n' "${FAILED[@]}"
    echo ""
    log_warn "Review log for details: $(get_log_file)"
fi

log_phase_end "System Phase"
exit 0  # Always exit 0 to continue to next phase
