#!/bin/bash
# Post-installation tasks
# Service health checks, group membership warnings, environment setup

set +e
set -u
set -o pipefail

SCRIPT_DIR="{{ .chezmoi.homeDir }}/.local/share/chezmoi-libs"
source "$SCRIPT_DIR/lib-logging.sh"
source "$SCRIPT_DIR/lib-state.sh"
source "$SCRIPT_DIR/lib-helpers.sh"

PHASE="post-install"

# Initialize logging
init_log_file "$PHASE"

log_phase_start "Post-Installation Tasks"

# Initialize state
init_state_db

# Service health checks
log_info "Checking service status..."

SERVICES_TO_CHECK=()

# Check if MongoDB was installed
if command -v mongosh &>/dev/null || command -v mongo &>/dev/null; then
    SERVICES_TO_CHECK+=("mongod:mongodb")
fi

# Check if Docker was installed
if command -v docker &>/dev/null; then
    SERVICES_TO_CHECK+=("docker:docker")
fi

for service_entry in "${SERVICES_TO_CHECK[@]}"; do
    # Split on colon (fedora_name:arch_name)
    IFS=: read -r fedora_service arch_service <<< "$service_entry"

    service="$fedora_service"
    if [ "$(get_distro)" = "arch" ]; then
        service="$arch_service"
    fi

    if systemctl is-active "$service" &>/dev/null; then
        log_info "✓ $service is running"
    elif systemctl is-enabled "$service" &>/dev/null; then
        log_warn "⚠ $service is enabled but not running"
        log_info "Starting $service..."
        sudo systemctl start "$service" || log_error "Failed to start $service"
    else
        log_debug "$service not installed or not enabled"
    fi
done

# Group membership warnings
log_info "Checking group memberships..."

GROUPS_ADDED=()

if command -v docker &>/dev/null; then
    if check_user_in_group "docker"; then
        # Check if group was added this session (not in initial groups)
        if ! echo "$GROUPS_INITIAL" | grep -q "\bdocker\b" 2>/dev/null; then
            GROUPS_ADDED+=("docker")
        fi
    fi
fi

if [ ${#GROUPS_ADDED[@]} -gt 0 ]; then
    echo ""
    log_warn "━━━ IMPORTANT ━━━"
    log_warn "You were added to the following groups:"
    printf '  • %s\n' "${GROUPS_ADDED[@]}"
    echo ""
    log_warn "Log out and back in for group changes to take effect"
    log_warn "Or run: newgrp docker (temporary for current shell)"
    echo ""
fi

# Environment setup reminders
NEEDS_SHELL_RESTART=false

if command -v fnm &>/dev/null; then
    if ! echo "$PATH" | grep -q ".local/share/fnm"; then
        log_warn "fnm is installed but not in PATH"
        log_warn "Restart your shell or run: source ~/.bashrc"
        NEEDS_SHELL_RESTART=true
    fi
fi

if command -v bun &>/dev/null; then
    if ! echo "$PATH" | grep -q ".bun/bin"; then
        log_warn "bun is installed but not in PATH"
        log_warn "Restart your shell or run: source ~/.bashrc"
        NEEDS_SHELL_RESTART=true
    fi
fi

if [ "$NEEDS_SHELL_RESTART" = true ]; then
    echo ""
    log_info "Some tools require a shell restart to be available in PATH"
fi

log_phase_end "Post-Installation"
exit 0
