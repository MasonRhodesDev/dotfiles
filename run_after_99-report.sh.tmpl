#!/bin/bash
# Installation completion summary report

set +e
set -u
set -o pipefail

SCRIPT_DIR="{{ .chezmoi.homeDir }}/.local/share/chezmoi-libs"
source "$SCRIPT_DIR/lib-logging.sh"
source "$SCRIPT_DIR/lib-state.sh"
source "$SCRIPT_DIR/lib-helpers.sh"

STATE_DB="{{ .chezmoi.homeDir }}/.local/state/chezmoi-installs/state.db.json"

echo ""
echo -e "${COLOR_HEADER}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${COLOR_RESET}"
echo -e "${COLOR_HEADER}  Dotfiles Setup Complete!${COLOR_RESET}"
echo -e "${COLOR_HEADER}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${COLOR_RESET}"
echo ""

# System information
echo "System Information:"
echo "  Profile: {{ .profile.type }}"
echo "  Hostname: {{ .chezmoi.hostname }}"
echo "  OS: {{ .chezmoi.osRelease.id }} {{ if hasKey .chezmoi.osRelease "versionID" }}{{ .chezmoi.osRelease.versionID }}{{ else }}rolling{{ end }}"
echo "  Architecture: {{ .chezmoi.arch }}"
echo ""

# Check state DB
if [ ! -f "$STATE_DB" ]; then
    log_warn "No state database found - installation may not have run"
    exit 0
fi

# Aggregate statistics
TOTAL_SUCCESS=0
TOTAL_FAILED=0
TOTAL_SKIPPED=0

for phase in system user profile-work profile-personal; do
    phase_status=$(jq -r ".phases.\"$phase\".categories // {} | to_entries | length" "$STATE_DB" 2>/dev/null)
    if [ "$phase_status" != "0" ] && [ "$phase_status" != "null" ]; then
        success=$(jq -r ".phases.\"$phase\".categories // {} | to_entries[] | select(.value.status == \"success\") | .key" "$STATE_DB" 2>/dev/null | wc -l)
        failed=$(jq -r ".phases.\"$phase\".categories // {} | to_entries[] | select(.value.status == \"failed\") | .key" "$STATE_DB" 2>/dev/null | wc -l)
        skipped=$(jq -r ".phases.\"$phase\".categories // {} | to_entries[] | select(.value.status == \"skipped\") | .key" "$STATE_DB" 2>/dev/null | wc -l)

        TOTAL_SUCCESS=$((TOTAL_SUCCESS + success))
        TOTAL_FAILED=$((TOTAL_FAILED + failed))
        TOTAL_SKIPPED=$((TOTAL_SKIPPED + skipped))
    fi
done

# Display summary
echo "Installation Summary:"
echo "  ✓ Successful: $TOTAL_SUCCESS categories"
echo "  ⊘ Skipped: $TOTAL_SKIPPED categories"
echo "  ✗ Failed: $TOTAL_FAILED categories"
echo ""

# Show failed categories if any
if [ "$TOTAL_FAILED" -gt 0 ]; then
    echo -e "${COLOR_ERROR}Failed Categories:${COLOR_RESET}"
    for phase in system user profile-work profile-personal; do
        failed_cats=$(jq -r ".phases.\"$phase\".categories // {} | to_entries[] | select(.value.status == \"failed\") | \"  ✗ \" + .key + \" (\" + .value.error + \")\"" "$STATE_DB" 2>/dev/null)
        if [ -n "$failed_cats" ]; then
            echo "$failed_cats"
        fi
    done
    echo ""
fi

# Show recent logs
CACHE_DIR="{{ .chezmoi.homeDir }}/.cache/dotfiles-install"
if [ -d "$CACHE_DIR" ]; then
    echo "Installation Logs:"
    find "$CACHE_DIR" -name "*.log" -type f -printf '%T@ %p\n' 2>/dev/null | \
        sort -rn | \
        head -n 5 | \
        cut -d' ' -f2- | \
        while read log; do
            size=$(du -h "$log" | cut -f1)
            logname=$(basename "$log")
            echo "  - $logname ($size)"
        done
    echo ""
fi

# Next steps
echo "Next Steps:"

if [ "$TOTAL_FAILED" -gt 0 ]; then
    echo "  1. Review logs above for failure details"
    echo "  2. Fix issues and retry: chezmoi apply --force"
fi

if command -v fnm &>/dev/null || command -v bun &>/dev/null; then
    echo "  • Restart your shell: exec \$SHELL"
fi

if command -v docker &>/dev/null && check_user_in_group "docker"; then
    echo "  • Log out and back in for Docker group membership"
fi

{{- if eq .profile.type "work" }}
if command -v mongosh &>/dev/null; then
    echo "  • Verify MongoDB: systemctl status mongod"
fi
{{- end }}

if [ "$TOTAL_SUCCESS" -gt 0 ]; then
    echo ""
    echo -e "${COLOR_INFO}✓ Setup completed successfully!${COLOR_RESET}"
else
    echo ""
    echo -e "${COLOR_WARN}⚠ Setup completed with warnings${COLOR_RESET}"
fi

echo ""
exit 0
