#!/bin/bash
# Run full installation when packages.toml changes
# This script runs automatically via chezmoi when packages.toml is modified

set -e

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Package Registry Updated"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "packages.toml has changed, triggering full installation..."
echo ""

# Hash of packages.toml (chezmoi uses this to detect changes)
# packages.toml: {{ include "software_installers/packages.toml" | sha256sum }}

SCRIPT_DIR="{{ .chezmoi.homeDir }}/.local/share/chezmoi"

# Clear state to force reinstallation of changed categories
if [ -f "$HOME/.local/state/chezmoi-installs/state.db.json" ]; then
    echo "Clearing installation state to detect package changes..."
    rm -f "$HOME/.local/state/chezmoi-installs/state.db.json"
fi

# Run installation phases
echo ""
echo "Running system-level installation..."
if [ -x "$SCRIPT_DIR/run_after_10-system-packages.sh" ]; then
    "$SCRIPT_DIR/run_after_10-system-packages.sh"
fi

echo ""
echo "Running user-level installation..."
if [ -x "$SCRIPT_DIR/run_after_20-user-packages.sh" ]; then
    "$SCRIPT_DIR/run_after_20-user-packages.sh"
fi

echo ""
echo "Running profile-specific installation..."
{{ if eq .profile.type "work" -}}
if [ -x "$SCRIPT_DIR/run_after_30-profile-work.sh" ]; then
    "$SCRIPT_DIR/run_after_30-profile-work.sh"
fi
{{- else -}}
if [ -x "$SCRIPT_DIR/run_after_30-profile-personal.sh" ]; then
    "$SCRIPT_DIR/run_after_30-profile-personal.sh"
fi
{{- end }}

echo ""
echo "Running post-installation tasks..."
if [ -x "$SCRIPT_DIR/run_after_90-post-install.sh" ]; then
    "$SCRIPT_DIR/run_after_90-post-install.sh"
fi

echo ""
echo "✓ Package installation complete"
