#!/bin/bash

source "$(dirname "$0")/__helpers.sh"

{{- if .is_work }}
echo "Installing MongoDB (work machine)..."

if [ "$(get_distro)" = "fedora" ]; then
    # Use MongoDB 8.0 (latest stable major version as of 2025)
    # MongoDB major versions are stable for long periods, so 8.0 is appropriate
    mongo_version="8.0"
    echo "Using MongoDB version: $mongo_version"
    
    # Add MongoDB repository
    mongo_repo_file="/etc/yum.repos.d/mongodb-org-${mongo_version}.repo"
    if [ ! -f "$mongo_repo_file" ]; then
        echo "[mongodb-org-${mongo_version}]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/9/mongodb-org/${mongo_version}/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://pgp.mongodb.com/server-${mongo_version}.asc" | sudo tee "$mongo_repo_file"
    fi
    
    # Install MongoDB
    install_packages "mongodb-org mongodb-mongosh" ""
    
    # Configure MongoDB
    sudo systemctl start mongod
    sudo systemctl enable mongod
    
    # Initialize replica set
    if ! mongosh --quiet --eval "rs.status()" &> /dev/null; then
        echo "Initializing MongoDB replica set..."
        mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'localhost:27017'}]})"
    fi
    
    # Install MongoDB Compass (latest version)
    if ! command -v mongodb-compass &> /dev/null; then
        echo "Installing MongoDB Compass (detecting latest version)..."
        
        # Get latest MongoDB Compass version from GitHub API
        latest_compass_info=$(curl -s "https://api.github.com/repos/mongodb-js/compass/releases/latest")
        latest_version=$(echo "$latest_compass_info" | jq -r '.tag_name' | sed 's/^v//')
        
        if [ "$latest_version" != "null" ] && [ -n "$latest_version" ]; then
            compass_rpm_url="https://downloads.mongodb.com/compass/mongodb-compass-${latest_version}.x86_64.rpm"
            echo "Found latest MongoDB Compass version: $latest_version"
            
            # Download and install
            wget -O /tmp/mongodb-compass.rpm "$compass_rpm_url"
            if [ $? -eq 0 ]; then
                sudo dnf install -y /tmp/mongodb-compass.rpm
                rm /tmp/mongodb-compass.rpm
            else
                echo "Failed to download MongoDB Compass. Falling back to known version..."
                wget -O /tmp/mongodb-compass.rpm https://downloads.mongodb.com/compass/mongodb-compass-1.44.5.x86_64.rpm
                sudo dnf install -y /tmp/mongodb-compass.rpm
                rm /tmp/mongodb-compass.rpm
            fi
        else
            echo "Could not detect latest version. Using fallback version..."
            wget -O /tmp/mongodb-compass.rpm https://downloads.mongodb.com/compass/mongodb-compass-1.44.5.x86_64.rpm
            sudo dnf install -y /tmp/mongodb-compass.rpm
            rm /tmp/mongodb-compass.rpm
        fi
    fi

elif [ "$(get_distro)" = "arch" ]; then
    # Install via AUR
    install_aur_packages "mongodb-bin mongodb-tools-bin mongodb-compass"
    
    # Enable and start service
    sudo systemctl enable mongodb
    sudo systemctl start mongodb
    
    # Initialize replica set
    if ! mongosh --quiet --eval "rs.status()" &> /dev/null; then
        echo "Initializing MongoDB replica set..."
        mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'localhost:27017'}]})"
    fi
fi

echo "MongoDB installation complete!"
{{- else }}
echo "Skipped MongoDB installation (not a work machine)"
{{- end }}