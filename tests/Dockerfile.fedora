# Fedora 41 test container for chezmoi dotfiles
FROM fedora:41

# Install minimal dependencies (yq will be auto-installed by ensure_yq())
RUN dnf install -y \
    git \
    curl \
    sudo \
    && dnf clean all

# Create test user (mason)
RUN useradd -m -s /bin/bash mason && \
    echo "mason ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set hostname for work profile
RUN echo "mason-work-test" > /etc/hostname

# Switch to test user
USER mason
WORKDIR /home/mason

# Install chezmoi
RUN sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /home/mason/.local/bin

# Add chezmoi to PATH
ENV PATH="/home/mason/.local/bin:${PATH}"

# Set up git config (required by chezmoi)
RUN git config --global user.email "test@example.com" && \
    git config --global user.name "Test User" && \
    git config --global init.defaultBranch main

# Copy dotfiles repo into container
COPY --chown=mason:mason . /home/mason/.local/share/chezmoi/

# Set chezmoi source directory
ENV CHEZMOI_SOURCE_DIR=/home/mason/.local/share/chezmoi

WORKDIR /home/mason

# Default command runs a shell
CMD ["/bin/bash"]
