#!/bin/bash
# Personal profile specific installations

{{- if ne .profile.type "personal" }}
# Not a personal machine - skip execution
exit 0
{{- end }}

set +e
set -u
set -o pipefail

SCRIPT_DIR="{{ .chezmoi.homeDir }}/.local/share/chezmoi-libs"
source "$SCRIPT_DIR/lib-logging.sh"
source "$SCRIPT_DIR/lib-state.sh"
source "$SCRIPT_DIR/lib-collision.sh"
source "$SCRIPT_DIR/lib-helpers.sh"

PHASE="profile-personal"

# Initialize logging
init_log_file "$PHASE"

log_phase_start "Personal Profile Installation"

# Initialize state
init_state_db
init_collision_detection

# Acquire lock
if ! acquire_lock; then
    log_error "Could not acquire installation lock"
    exit 0
fi

# Build category list (personal profile only)
PACKAGE_REGISTRY="{{ .chezmoi.sourceDir }}/software_installers/packages.toml"

CATEGORIES=()

cats=$(yq eval ".personal | keys | .[]" "$PACKAGE_REGISTRY" 2>/dev/null)
for category in $cats; do
    CATEGORIES+=("personal.${category}")
done

if [ ${#CATEGORIES[@]} -eq 0 ]; then
    log_info "No personal packages defined"
    exit 0
fi

log_info "Personal profile categories to install: ${#CATEGORIES[@]}"

# Install each category
FAILED=()
SUCCEEDED=()
SKIPPED=()

for category in "${CATEGORIES[@]}"; do
    # Determine install level for this category
    cat_name="${category#personal.}"
    install_level=$(yq eval ".personal.\"$cat_name\".install_level // \"system\"" "$PACKAGE_REGISTRY" 2>/dev/null)

    if install_packages_from_registry "$category" "$PHASE"; then
        SUCCEEDED+=("$category")
    else
        status=$(get_category_status "$PHASE" "$category")
        if [ "$status" = "skipped" ]; then
            SKIPPED+=("$category")
        else
            FAILED+=("$category")
        fi
    fi
done

# Summary
echo ""
log_info "━━━ Personal Profile Summary ━━━"
log_info "Succeeded: ${#SUCCEEDED[@]}"
log_info "Skipped: ${#SKIPPED[@]}"
log_info "Failed: ${#FAILED[@]}"

if [ ${#SUCCEEDED[@]} -gt 0 ]; then
    log_info "✓ Successfully installed:"
    printf '  ✓ %s\n' "${SUCCEEDED[@]}"
fi

if [ ${#SKIPPED[@]} -gt 0 ]; then
    log_info "⊘ Skipped:"
    printf '  ⊘ %s\n' "${SKIPPED[@]}"
fi

if [ ${#FAILED[@]} -gt 0 ]; then
    log_error "✗ Failed categories:"
    printf '  ✗ %s\n' "${FAILED[@]}"
fi

log_phase_end "Personal Profile"
exit 0
